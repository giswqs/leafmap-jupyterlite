---
jupytext:
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.14.0
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---

[![image](https://jupyterlite.rtfd.io/en/latest/_static/badge.svg)](https://demo.leafmap.org/lab/index.html?path=workshops/FOSS4G_2021.ipynb)
[![image](https://colab.research.google.com/assets/colab-badge.svg)](https://gishub.org/foss4g-colab)
[![image](https://mybinder.org/badge_logo.svg)](https://gishub.org/foss4g-binder)
[![image](https://mybinder.org/badge_logo.svg)](https://gishub.org/foss4g-binder-nb)
![](https://i.imgur.com/fag5KRb.png)

+++

**Using Leafmap for Geospatial Analysis and Data Visualization**


This notebook was developed for the [leafmap workshop](https://callforpapers.2021.foss4g.org/foss4g-2021-workshop/talk/VAHX9A/) taking place on September 27, 2021 at the [FOSS4G 2021 Conference](https://2021.foss4g.org/).

Author: [Qiusheng Wu](https://github.com/giswqs)

Launch this notebook to execute code interactively using: 
- Google Colab: https://gishub.org/foss4g-colab
- Pangeo Binder JupyterLab: https://gishub.org/foss4g-binder
- Pangeo Binder Jupyter Notebook: https://gishub.org/foss4g-binder-nb


## Introduction

### Workshop description

[Leafmap](https://leafmap.org) is a Python package for interactive mapping and geospatial analysis with minimal coding in a Jupyter environment. It is built upon a number of open-source packages, such as [folium](https://github.com/python-visualization/folium) and [ipyleaflet](https://github.com/jupyter-widgets/ipyleaflet) (for creating interactive maps), [WhiteboxTools](https://github.com/jblindsay/whitebox-tools) and [whiteboxgui](https://github.com/giswqs/whiteboxgui) (for analyzing geospatial data), and [ipywidgets](https://github.com/jupyter-widgets/ipywidgets) (for designing interactive graphical user interface). The WhiteboxTools library currently contains 480+ tools for advanced geospatial analysis. Leafmap provides many convenient functions for loading and visualizing geospatial data with only one line of code. Users can also use the interactive user interface to load geospatial data without coding. Anyone with a web browser and Internet connection can use leafmap to perform geospatial analysis and data visualization in the cloud with minimal coding. The topics that will be covered in this workshop include: 

1. Creating interactive maps
2. Changing basemaps
3. Loading and visualizing vector/raster data
4. Using Cloud Optimized GeoTIFF (COG) and SpatialTemporal Asset Catalog (STAC)
5. Downloading OpenStreetMap data
6. Loading data from a PostGIS database
7. Creating custom legends and colorbars
8. Creating split-panel maps and linked maps
9. Visualizing Planet global monthly/quarterly mosaic
10. Designing and publishing interactive web apps
11. Performing geospatial analysis (e.g., hydrological analysis and LiDAR data analysis) using whiteboxgui.

This workshop is intended for scientific programmers, data scientists, geospatial analysts, and concerned citizens of Earth. The attendees are expected to have a basic understanding of Python and the Jupyter ecosystem. Familiarity with Earth science and geospatial datasets is useful but not required. More information about leafmap can be found at https://leafmap.org


### Jupyter keyboard shortcuts

- Shift+Enter: run cell, select below
- Ctrl+Enter: : run selected cells
- Alt+Enter: run cell and insert below
- Tab: code completion or indent
- Shift+Tab: tooltip
- Ctrl+/: comment out code

+++

## Set up environment

### Required Python packages:
* [leafmap](https://github.com/giswqs/leafmap) - A Python package for interactive mapping and geospatial analysis with minimal coding in a Jupyter environment
* [geopandas](https://geopandas.org) - An open source project to make working with geospatial data in python easier. 
* [keplergl](https://docs.kepler.gl/docs/keplergl-jupyter) - A high-performance web-based application for visual exploration of large-scale geolocation data sets
* [datapane](https://datapane.com) - A Python library for building interactive reports in seconds
* [xarray-leaflet](https://github.com/davidbrochart/xarray_leaflet) - An xarray extension for tiled map plotting

### Required API keys
- [HERE Map](https://developer.here.com) API key
- [datapane](https://datapane.com) API key
- [Planet](https://www.planet.com/nicfi) API key

### Use Google Colab

Click the button below to open this notebook in Google Colab and execute code interactively.

[![image](https://jupyterlite.rtfd.io/en/latest/_static/badge.svg)](https://demo.leafmap.org/lab/index.html?path=workshops/FOSS4G_2021.ipynb)
[![image](https://colab.research.google.com/assets/colab-badge.svg)](https://githubtocolab.com/giswqs/leafmap/blob/master/examples/workshops/foss4g_2021.ipynb)

```{code-cell} ipython3
import os
import subprocess
import sys
```

```{code-cell} ipython3
import warnings

warnings.filterwarnings("ignore")
```

A function for installing Python packages.

```{code-cell} ipython3
def install(package):
    subprocess.check_call([sys.executable, "-m", "pip", "install", package])
```

Install required Python packages in Google Colab.

```{code-cell} ipython3
pkgs = [
    'leafmap',
    'geopandas',
    'keplergl',
    'datapane',
    'xarray_leaflet',
    'osmnx',
    'pygeos',
    'imageio',
    'tifffile',
]
if "google.colab" in sys.modules:
    for pkg in pkgs:
        install(pkg)
```

### Use Pangeo Binder

Click the buttons below to open this notebook in JupyterLab (first button) or Jupyter Notebook (second button) and execute code interactively.

[![image](https://mybinder.org/badge_logo.svg)](https://gishub.org/foss4g-binder)
[![image](https://mybinder.org/badge_logo.svg)](https://gishub.org/foss4g-binder-nb)

- JupyterLab: https://gishub.org/foss4g-binder
- Jupyter Notebook: https://gishub.org/foss4g-binder-nb

+++

### Use Miniconda/Anaconda

If you have
[Anaconda](https://www.anaconda.com/distribution/#download-section) or [Miniconda](https://docs.conda.io/en/latest/miniconda.html) installed on your computer, you can install leafmap using the following commands. Leafmap has an optional dependency - [geopandas](https://geopandas.org), which can be challenging to install on some computers, especially Windows. It is highly recommended that you create a fresh conda environment to install geopandas and leafmap. Follow the commands below to set up a conda env and install geopandas, leafmap, datapane, keplergl, and xarray_leaflet. 

```
conda create -n geo python=3.8
conda activate geo
conda install geopandas
conda install mamba -c conda-forge
mamba install leafmap datapane keplergl xarray_leaflet -c conda-forge
mamba install osmnx pygeos imageio tifffile -c conda-forge
pip install -U folium
jupyter lab
```

```{code-cell} ipython3
try:
    import leafmap
except ImportError:
    install('leafmap')
```

## Create an interactive map

`leafmap` has four plotting backends: [folium](https://github.com/python-visualization/folium), [ipyleaflet](https://github.com/jupyter-widgets/ipyleaflet), [here-map](https://github.com/heremaps/here-map-widget-for-jupyter), and [kepler.gl](https://docs.kepler.gl/docs/keplergl-jupyter). Note that the backends do not offer equal functionality. Some interactive functionality in `ipyleaflet` might not be available in other plotting backends. To use a specific plotting backend, use one of the following:

- `import leafmap.leafmap as leafmap`
- `import leafmap.foliumap as leafmap`
- `import leafmap.heremap as leafmap`
- `import leafmap.kepler as leafmap`


### Use ipyleaflet

```{code-cell} ipython3
import leafmap

m = leafmap.Map()
m
```

### Use folium

```{code-cell} ipython3
import leafmap.foliumap as leafmap

m = leafmap.Map()
m
```

### Use kepler.gl

```{code-cell} ipython3
import leafmap.kepler as leafmap

m = leafmap.Map()
m
```

If you encounter an error saying `Error displaying widget: model not found` when trying to display the map, you can use `m.static_map()` as a workaround until this [kepler.gl bug](https://github.com/keplergl/kepler.gl/issues/1165) has been resolved.  

```{code-cell} ipython3
m.static_map(width=1280, height=600)
```

### Use here-map

Before you run the below cells make sure you have:
- A HERE developer account, free and available under [HERE Developer Portal](https://developer.here.com)
- An [API key](https://developer.here.com/documentation/identity-access-management/dev_guide/topics/dev-apikey.html) from the [HERE Developer Portal](https://developer.here.com)

```{code-cell} ipython3
import os
import leafmap.heremap as leafmap
```

```{code-cell} ipython3
if os.environ.get("HEREMAPS_API_KEY") is None:
    os.environ["HEREMAPS_API_KEY"] = 'your-api-key'

m = leafmap.Map()
m
```

## Customize the default map

### Specify map center and zoom level

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
m = leafmap.Map(center=(40, -100), zoom=4)  # center=[lat, lon]
m
```

```{code-cell} ipython3
m = leafmap.Map(center=(51.5, -0.15), zoom=17)
m
```

### Change map size

```{code-cell} ipython3
m = leafmap.Map(height="400px", width="800px")
m
```

### Set control visibility

When creating a map, set the following controls to either `True` or `False` as appropriate.

* attribution_control
* draw_control
* fullscreen_control
* layers_control
* measure_control
* scale_control
* toolbar_control

```{code-cell} ipython3
m = leafmap.Map(
    draw_control=False,
    measure_control=False,
    fullscreen_control=False,
    attribution_control=False,
)
m
```

Remove all controls from the map.

```{code-cell} ipython3
m = leafmap.Map()
m.clear_controls()
m
```

## Change basemaps

Specify a Google basemap to use, can be one of ["ROADMAP", "TERRAIN", "SATELLITE", "HYBRID"].

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
m = leafmap.Map(google_map="TERRAIN")  # HYBIRD, ROADMAP, SATELLITE, TERRAIN
m
```

Add a basemap using the `add_basemap()` function.

```{code-cell} ipython3
m = leafmap.Map()
m.add_basemap("Esri.NatGeoWorldMap")
m
```

Print out the list of available basemaps.

```{code-cell} ipython3
for basemap in leafmap.basemaps:
    print(basemap)
```

## Add tile layers

### Add XYZ tile layer

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
m = leafmap.Map()
m.add_tile_layer(
    url="https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",
    name="Google Satellite",
    attribution="Google",
)
m
```

### Add WMS tile layer

More WMS basemaps can be found at the following websites:

- USGS National Map: https://viewer.nationalmap.gov/services
- MRLC NLCD Land Cover data: https://www.mrlc.gov/data-services-page
- FWS NWI Wetlands data: https://www.fws.gov/wetlands/Data/Web-Map-Services.html

```{code-cell} ipython3
m = leafmap.Map()
naip_url = 'https://services.nationalmap.gov/arcgis/services/USGSNAIPImagery/ImageServer/WMSServer?'
m.add_wms_layer(
    url=naip_url, layers='0', name='NAIP Imagery', format='image/png', shown=True
)
m
```

### Add xyzservices provider

Add a layer from [xyzservices](https://github.com/geopandas/xyzservices) provider object.

```{code-cell} ipython3
import os
import xyzservices.providers as xyz
```

```{code-cell} ipython3
basemap = xyz.HEREv3.basicMap
basemap
```

```{code-cell} ipython3
basemap['apiKey'] = os.environ["HEREMAPS_API_KEY"]
```

```{code-cell} ipython3
m = leafmap.Map()
m.add_basemap(basemap)
m
```

## Add vector tile layer

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
m = leafmap.Map()
```

The URL to the vector tile.

```{code-cell} ipython3
url = 'https://tile.nextzen.org/tilezen/vector/v1/512/all/{z}/{x}/{y}.mvt?api_key=gCZXZglvRQa6sB2z7JzL1w'
```

Attribution of the vector tile.

```{code-cell} ipython3
attribution = "Nextzen"
```

One can customize the vector tile layer style if needed. More info can be found at https://ipyleaflet.readthedocs.io/en/latest/api_reference/vector_tile.html

```{code-cell} ipython3
vector_tile_layer_styles = {}
```

Add the vector tile layer to the map.

```{code-cell} ipython3
m.add_vector_tile_layer(url, attribution, vector_tile_layer_styles)
m
```

## Add COG/STAC layers

A Cloud Optimized GeoTIFF (COG) is a regular GeoTIFF file, aimed at being hosted on a HTTP file server, with an internal organization that enables more efficient workflows on the cloud. It does this by leveraging the ability of clients issuing HTTP GET range requests to ask for just the parts of a file they need. 

More information about COG can be found at <https://www.cogeo.org/in-depth.html>

Some publicly available Cloud Optimized GeoTIFFs:

* https://stacindex.org/
* https://cloud.google.com/storage/docs/public-datasets/landsat
* https://www.digitalglobe.com/ecosystem/open-data
* https://earthexplorer.usgs.gov/

For this demo, we will use data from https://www.maxar.com/open-data/california-colorado-fires for mapping California and Colorado fires. A list of COGs can be found [here](https://github.com/giswqs/leafmap/blob/master/examples/data/cog_files.txt).

### Add COG layer

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
m = leafmap.Map()
url = 'https://opendata.digitalglobe.com/events/california-fire-2020/pre-event/2018-02-16/pine-gulch-fire20/1030010076004E00.tif'
url2 = 'https://opendata.digitalglobe.com/events/california-fire-2020/post-event/2020-08-14/pine-gulch-fire20/10300100AAC8DD00.tif'

m.add_cog_layer(url, name="Fire (pre-event)")
m.add_cog_layer(url2, name="Fire (post-event)")
m
```

Retrieve the bounding box coordinates of the COG file.

```{code-cell} ipython3
leafmap.cog_bounds(url)
```

Retrieve the centroid coordinates of the COG file.

```{code-cell} ipython3
leafmap.cog_center(url)
```

Retrieves the tile layer URL of the COG file.

```{code-cell} ipython3
leafmap.cog_tile(url)
```

### Add STAC layer

The SpatioTemporal Asset Catalog (STAC) specification provides a common language to describe a range of geospatial information, so it can more easily be indexed and discovered. A 'spatiotemporal asset' is any file that represents information about the earth captured in a certain space and time. The initial focus is primarily remotely-sensed imagery (from satellites, but also planes, drones, balloons, etc), but the core is designed to be extensible to SAR, full motion video, point clouds, hyperspectral, LiDAR and derived data like NDVI, Digital Elevation Models, mosaics, etc. More information about STAC can be found at https://stacspec.org/

Some publicly available SpatioTemporal Asset Catalog (STAC):

* https://stacindex.org

For this demo, we will use STAC assets from https://stacindex.org/catalogs/spot-orthoimages-canada-2005#/?t=catalogs

```{code-cell} ipython3
m = leafmap.Map()
url = 'https://canada-spot-ortho.s3.amazonaws.com/canada_spot_orthoimages/canada_spot5_orthoimages/S5_2007/S5_11055_6057_20070622/S5_11055_6057_20070622.json'
m.add_stac_layer(url, bands=['B3', 'B2', 'B1'], name='False color')
m
```

Retrieve the bounding box coordinates of the STAC file.

```{code-cell} ipython3
leafmap.stac_bounds(url)
```

Retrieve the centroid coordinates of the STAC file.

```{code-cell} ipython3
leafmap.stac_center(url)
```

Retrieve the band names of the STAC file.

```{code-cell} ipython3
leafmap.stac_bands(url)
```

Retrieve the tile layer URL of the STAC file.

```{code-cell} ipython3
leafmap.stac_tile(url, bands=['B3', 'B2', 'B1'])
```

## Add local raster datasets

The `add_raster` function relies on the `xarray_leaflet` package and is only available for the ipyleaflet plotting backend. Therefore, Google Colab is not supported. Note that `xarray_leaflet` does not work properly on Windows ([source](https://github.com/davidbrochart/xarray_leaflet/issues/30)).

```{code-cell} ipython3
import os
import leafmap
```

Download samples raster datasets

More datasets can be downloaded from https://viewer.nationalmap.gov/basic/

```{code-cell} ipython3
out_dir = os.getcwd()

landsat = os.path.join(out_dir, 'landsat.tif')
dem = os.path.join(out_dir, 'dem.tif')
```

Download a small Landsat imagery.

```{code-cell} ipython3
if not os.path.exists(landsat):
    landsat_url = 'https://drive.google.com/file/d/1EV38RjNxdwEozjc9m0FcO3LFgAoAX1Uw/view?usp=sharing'
    leafmap.download_from_gdrive(landsat_url, 'landsat.tif', out_dir, unzip=False)
```

Download a small DEM dataset.

```{code-cell} ipython3
if not os.path.exists(dem):
    dem_url = 'https://drive.google.com/file/d/1vRkAWQYsLWCi6vcTMk8vLxoXMFbdMFn8/view?usp=sharing'
    leafmap.download_from_gdrive(dem_url, 'dem.tif', out_dir, unzip=False)
```

```{code-cell} ipython3
m = leafmap.Map()
```

Add local raster datasets to the map

More colormap can be found at https://matplotlib.org/3.1.0/tutorials/colors/colormaps.html

```{code-cell} ipython3
m.add_raster(dem, colormap='terrain', layer_name='DEM')
```

```{code-cell} ipython3
m.add_raster(landsat, bands=[5, 4, 3], layer_name='Landsat')
```

```{code-cell} ipython3
m
```

## Add legend

### Add built-in legend

```{code-cell} ipython3
import leafmap
```

List all available built-in legends.

```{code-cell} ipython3
legends = leafmap.builtin_legends
for legend in legends:
    print(legend)
```

Add a WMS layer and built-in legend to the map.

```{code-cell} ipython3
m = leafmap.Map()
url = "https://www.mrlc.gov/geoserver/mrlc_display/NLCD_2019_Land_Cover_L48/wms?"
m.add_wms_layer(
    url,
    layers="NLCD_2019_Land_Cover_L48",
    name="NLCD 2019 CONUS Land Cover",
    format="image/png",
    transparent=True,
)
m.add_legend(builtin_legend='NLCD')
m
```

Add U.S. National Wetlands Inventory (NWI). More info at https://www.fws.gov/wetlands.

```{code-cell} ipython3
m = leafmap.Map(google_map="HYBRID")

url1 = "https://www.fws.gov/wetlands/arcgis/services/Wetlands/MapServer/WMSServer?"
m.add_wms_layer(
    url1, layers="1", format='image/png', transparent=True, name="NWI Wetlands Vector"
)

url2 = "https://www.fws.gov/wetlands/arcgis/services/Wetlands_Raster/ImageServer/WMSServer?"
m.add_wms_layer(
    url2, layers="0", format='image/png', transparent=True, name="NWI Wetlands Raster"
)

m.add_legend(builtin_legend="NWI")
m
```

### Add custom legend

There are two ways you can add custom legends:

1. Define legend labels and colors
2. Define legend dictionary

Define legend keys and colors

```{code-cell} ipython3
m = leafmap.Map()

labels = ['One', 'Two', 'Three', 'Four', 'ect']
# color can be defined using either hex code or RGB (0-255, 0-255, 0-255)
colors = ['#8DD3C7', '#FFFFB3', '#BEBADA', '#FB8072', '#80B1D3']
# colors = [(255, 0, 0), (127, 255, 0), (127, 18, 25), (36, 70, 180), (96, 68, 123)]

m.add_legend(title='Legend', labels=labels, colors=colors)
m
```

Define a legend dictionary.

```{code-cell} ipython3
m = leafmap.Map()

url = "https://www.mrlc.gov/geoserver/mrlc_display/NLCD_2019_Land_Cover_L48/wms?"
m.add_wms_layer(
    url,
    layers="NLCD_2019_Land_Cover_L48",
    name="NLCD 2019 CONUS Land Cover",
    format="image/png",
    transparent=True,
)

legend_dict = {
    '11 Open Water': '466b9f',
    '12 Perennial Ice/Snow': 'd1def8',
    '21 Developed, Open Space': 'dec5c5',
    '22 Developed, Low Intensity': 'd99282',
    '23 Developed, Medium Intensity': 'eb0000',
    '24 Developed High Intensity': 'ab0000',
    '31 Barren Land (Rock/Sand/Clay)': 'b3ac9f',
    '41 Deciduous Forest': '68ab5f',
    '42 Evergreen Forest': '1c5f2c',
    '43 Mixed Forest': 'b5c58f',
    '51 Dwarf Scrub': 'af963c',
    '52 Shrub/Scrub': 'ccb879',
    '71 Grassland/Herbaceous': 'dfdfc2',
    '72 Sedge/Herbaceous': 'd1d182',
    '73 Lichens': 'a3cc51',
    '74 Moss': '82ba9e',
    '81 Pasture/Hay': 'dcd939',
    '82 Cultivated Crops': 'ab6c28',
    '90 Woody Wetlands': 'b8d9eb',
    '95 Emergent Herbaceous Wetlands': '6c9fb8',
}

m.add_legend(legend_title="NLCD Land Cover Classification", legend_dict=legend_dict)
m
```

## Add colorbar

### Continuous color

Add a continuous colorbar with a custom palette to the map.

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
m = leafmap.Map()
m.add_basemap('USGS 3DEP Elevation')
colors = ['006633', 'E5FFCC', '662A00', 'D8D8D8', 'F5F5F5']
m.add_colorbar(colors=colors, vmin=0, vmax=4000)
m
```

### Categorical colorbar

```{code-cell} ipython3
m = leafmap.Map()

url = "https://elevation.nationalmap.gov/arcgis/services/3DEPElevation/ImageServer/WMSServer?"
m.add_wms_layer(
    url,
    layers="3DEPElevation:Hillshade Elevation Tinted",
    name="USGS 3DEP Elevation",
    format="image/png",
    transparent=True,
)

colors = ['006633', 'E5FFCC', '662A00', 'D8D8D8', 'F5F5F5']
m.add_colorbar(colors=colors, vmin=0, vmax=4000, categorical=True, step=4)
m
```

## Add colormap

The colormap functionality requires the ipyleaflet plotting backend. Folium is not supported.

```{code-cell} ipython3
import leafmap
import leafmap.colormaps as cm
```

### Common colormaps

Color palette for DEM data.

```{code-cell} ipython3
cm.palettes.dem
```

Show the DEM palette.

```{code-cell} ipython3
cm.plot_colormap(colors=cm.palettes.dem, axis_off=True)
```

Color palette for NDVI data.

```{code-cell} ipython3
cm.palettes.ndvi
```

Show the NDVI palette.

```{code-cell} ipython3
cm.plot_colormap(colors=cm.palettes.ndvi)
```

### Custom colormaps

Specify the number of classes for a palette.

```{code-cell} ipython3
cm.get_palette('terrain', n_class=8)
```

Show the terrain palette with 8 classes.

```{code-cell} ipython3
cm.plot_colormap(colors=cm.get_palette('terrain', n_class=8))
```

Create a palette with custom colors, label, and font size.

```{code-cell} ipython3
cm.plot_colormap(colors=["red", "green", "blue"], label="Temperature", font_size=12)
```

Create a discrete color palette.

```{code-cell} ipython3
cm.plot_colormap(
    colors=["red", "green", "blue"], discrete=True, label="Temperature", font_size=12
)
```

Specify the width and height for the palette.

```{code-cell} ipython3
cm.plot_colormap(
    'terrain',
    label="Elevation",
    width=8.0,
    height=0.4,
    orientation='horizontal',
    vmin=0,
    vmax=1000,
)
```

Change the orentation of the colormap to be vertical.

```{code-cell} ipython3
cm.plot_colormap(
    'terrain',
    label="Elevation",
    width=0.4,
    height=4,
    orientation='vertical',
    vmin=0,
    vmax=1000,
)
```

### Horizontal colormap

Add a horizontal colorbar to an interactive map.

```{code-cell} ipython3
m = leafmap.Map()
m.add_basemap("OpenTopoMap")
m.add_colormap(
    'terrain',
    label="Elevation",
    width=8.0,
    height=0.4,
    orientation='horizontal',
    vmin=0,
    vmax=4000,
)
m
```

### Vertical colormap

Add a vertical colorbar to an interactive map.

```{code-cell} ipython3
m = leafmap.Map()
m.add_basemap("OpenTopoMap")
m.add_colormap(
    'terrain',
    label="Elevation",
    width=0.4,
    height=4,
    orientation='vertical',
    vmin=0,
    vmax=4000,
)
m
```

### List of available colormaps

```{code-cell} ipython3
cm.plot_colormaps(width=12, height=0.4)
```

## Add vector datasets

### Add CSV

Read a CSV as a Pandas DataFrame.

```{code-cell} ipython3
import os
import leafmap
```

```{code-cell} ipython3
in_csv = 'https://raw.githubusercontent.com/giswqs/data/main/world/world_cities.csv'
df = leafmap.csv_to_df(in_csv)
df
```

Create a point layer from a CSV file containing lat/long information.

```{code-cell} ipython3
m = leafmap.Map()
m.add_xy_data(in_csv, x="longitude", y="latitude", layer_name="World Cities")
m
```

Set the output directory.

```{code-cell} ipython3
out_dir = os.getcwd()
out_shp = os.path.join(out_dir, 'world_cities.shp')
```

Convert a CSV file containing lat/long information to a shapefile.

```{code-cell} ipython3
leafmap.csv_to_shp(in_csv, out_shp)
```

Convert a CSV file containing lat/long information to a GeoJSON.

```{code-cell} ipython3
out_geojson = os.path.join(out_dir, 'world_cities.geojson')
leafmap.csv_to_geojson(in_csv, out_geojson)
```

Convert a CSV file containing lat/long information to a GeoPandas GeoDataFrame.

```{code-cell} ipython3
gdf = leafmap.csv_to_gdf(in_csv)
gdf
```

### Add GeoJSON

Add a GeoJSON to the map.

```{code-cell} ipython3
m = leafmap.Map(center=[0, 0], zoom=2)
in_geojson = 'https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/cable_geo.geojson'
m.add_geojson(in_geojson, layer_name="Cable lines", info_mode='on_hover')
m
```

Add a GeoJSON with random filled color to the map.

```{code-cell} ipython3
m = leafmap.Map(center=[0, 0], zoom=2)
url = "https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/countries.geojson"
m.add_geojson(
    url, layer_name="Countries", fill_colors=['red', 'yellow', 'green', 'orange']
)
m
```

Use the `style_callback` function for assigning a random color to each polygon.

```{code-cell} ipython3
import random

m = leafmap.Map(center=[0, 0], zoom=2)

url = "https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/countries.geojson"


def random_color(feature):
    return {
        'color': 'black',
        'fillColor': random.choice(['red', 'yellow', 'green', 'orange']),
    }


m.add_geojson(url, layer_name="Countries", style_callback=random_color)
m
```

Use custom `style` and `hover_style` functions.

```{code-cell} ipython3
m = leafmap.Map(center=[0, 0], zoom=2)
url = "https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/countries.geojson"
style = {
    "stroke": True,
    "color": "#0000ff",
    "weight": 2,
    "opacity": 1,
    "fill": True,
    "fillColor": "#0000ff",
    "fillOpacity": 0.1,
}
hover_style = {"fillOpacity": 0.7}
m.add_geojson(url, layer_name="Countries", style=style, hover_style=hover_style)
m
```

### Add shapefile

```{code-cell} ipython3
m = leafmap.Map(center=[0, 0], zoom=2)
in_shp = 'https://github.com/giswqs/leafmap/raw/master/examples/data/countries.zip'
m.add_shp(in_shp, layer_name="Countries")
m
```

### Add KML

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
m = leafmap.Map()
in_kml = 'https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/us_states.kml'
m.add_kml(in_kml, layer_name="US States KML")
m
```

### Add GeoDataFrame

```{code-cell} ipython3
import geopandas as gpd
```

```{code-cell} ipython3
m = leafmap.Map()
gdf = gpd.read_file(
    "https://github.com/giswqs/leafmap/raw/master/examples/data/cable_geo.geojson"
)
m.add_gdf(gdf, layer_name="Cable lines")
m
```

Read the GeoPandas sample dataset as a GeoDataFrame.

```{code-cell} ipython3
path_to_data = gpd.datasets.get_path("nybb")
gdf = gpd.read_file(path_to_data)
gdf
```

```{code-cell} ipython3
m = leafmap.Map()
m.add_gdf(gdf, layer_name="New York boroughs", fill_colors=["red", "green", "blue"])
m
```

+++ {"tags": []}

### Add point layer

Add a point layer using the interactive GUI.

![](https://i.imgur.com/1QVEtlN.gif)

```{code-cell} ipython3
m = leafmap.Map()
m
```

Add a point layer programmatically.

```{code-cell} ipython3
m = leafmap.Map()
url = "https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/us_cities.geojson"
m.add_point_layer(url, popup=["name", "pop_max"], layer_name="US Cities")
m
```

### Add vector

The `add_vector` function supports any vector data format supported by GeoPandas.

```{code-cell} ipython3
m = leafmap.Map(center=[0, 0], zoom=2)
url = "https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/countries.geojson"
m.add_vector(
    url, layer_name="Countries", fill_colors=['red', 'yellow', 'green', 'orange']
)
m
```

## Download OSM data

### OSM from geocode

Add OSM data of place(s) by name or ID to the map. Note that the leafmap custom layer control does not support GeoJSON, we need to use the ipyleaflet built-in layer control. 

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
m = leafmap.Map(toolbar_control=False, layers_control=True)
m.add_osm_from_geocode("New York City", layer_name='NYC')
m
```

```{code-cell} ipython3
m = leafmap.Map(toolbar_control=False, layers_control=True)
m.add_osm_from_geocode("Chicago, Illinois", layer_name='Chicago, IL')
m
```

### OSM from place

Add OSM entities within boundaries of geocodable place(s) to the map.

+++

Show OSM feature tags.
https://wiki.openstreetmap.org/wiki/Map_features

```{code-cell} ipython3
# leafmap.osm_tags_list()
```

### OSM from address

```{code-cell} ipython3
m = leafmap.Map(toolbar_control=False, layers_control=True)
m.add_osm_from_address(
    address="New York City", tags={"amenity": "bar"}, dist=1500, layer_name="NYC bars"
)
m
```

```{code-cell} ipython3
m = leafmap.Map(toolbar_control=False, layers_control=True)
m.add_osm_from_address(
    address="New York City",
    tags={"landuse": ["retail", "commercial"], "building": True},
    dist=1000,
    layer_name="NYC buildings",
)
m
```

### OSM from bbox

```{code-cell} ipython3
m = leafmap.Map(toolbar_control=False, layers_control=True)
north, south, east, west = 40.7551, 40.7454, -73.9738, -73.9965
m.add_osm_from_bbox(
    north, south, east, west, tags={"amenity": "bar"}, layer_name="NYC bars"
)
m
```

### OSM from point

Add OSM entities within some distance N, S, E, W of a point to the map.

```{code-cell} ipython3
m = leafmap.Map(
    center=[46.7808, -96.0156], zoom=12, toolbar_control=False, layers_control=True
)
m.add_osm_from_point(
    center_point=(46.7808, -96.0156),
    tags={"natural": "water"},
    dist=10000,
    layer_name="Lakes",
)
m
```

```{code-cell} ipython3
m = leafmap.Map(
    center=[39.9170, 116.3908], zoom=15, toolbar_control=False, layers_control=True
)
m.add_osm_from_point(
    center_point=(39.9170, 116.3908),
    tags={"building": True, "natural": "water"},
    dist=1000,
    layer_name="Beijing",
)
m
```

### OSM from view

Add OSM entities within the current map view to the map.

```{code-cell} ipython3
m = leafmap.Map(toolbar_control=False, layers_control=True)
m.set_center(-73.9854, 40.7500, 16)
m
```

```{code-cell} ipython3
m.add_osm_from_view(tags={"amenity": "bar", "building": True}, layer_name="New York")
```

Create a GeoPandas GeoDataFrame from place.

```{code-cell} ipython3
gdf = leafmap.osm_gdf_from_place("New York City", tags={"amenity": "bar"})
gdf
```

## Use WhiteboxTools

Use the built-in toolbox to perform geospatial analysis. For example, you can perform depression filling using the sample DEM dataset downloaded in the above step.

![](https://i.imgur.com/KGHly63.png)

```{code-cell} ipython3
import os
import leafmap
import urllib.request
```

Download a sample DEM dataset.

```{code-cell} ipython3
url = 'https://github.com/giswqs/whitebox-python/raw/master/whitebox/testdata/DEM.tif'
```

```{code-cell} ipython3
urllib.request.urlretrieve(url, "dem.tif")
```

```{code-cell} ipython3
m = leafmap.Map()
m
```

Display the toolbox using the default mode.

```{code-cell} ipython3
leafmap.whiteboxgui()
```

Display the toolbox using the collapsible tree mode. Note that the tree mode does not support Google Colab. 

```{code-cell} ipython3
leafmap.whiteboxgui(tree=True)
```

Perform geospatial analysis using the [whitebox](https://github.com/giswqs/whitebox-python) package. 

```{code-cell} ipython3
import os
import whitebox
```

```{code-cell} ipython3
wbt = whitebox.WhiteboxTools()
wbt.verbose = False
```

```{code-cell} ipython3
wbt.version()
```

```{code-cell} ipython3
data_dir = os.getcwd()
wbt.set_working_dir(data_dir)
```

```{code-cell} ipython3
wbt.feature_preserving_smoothing("dem.tif", "smoothed.tif", filter=9)
wbt.breach_depressions("smoothed.tif", "breached.tif")
wbt.d_inf_flow_accumulation("breached.tif", "flow_accum.tif")
```

```{code-cell} ipython3
import matplotlib.pyplot as plt
import imageio

%matplotlib inline
```

```{code-cell} ipython3
original = imageio.imread(os.path.join(data_dir, 'dem.tif'))
smoothed = imageio.imread(os.path.join(data_dir, 'smoothed.tif'))
breached = imageio.imread(os.path.join(data_dir, 'breached.tif'))
flow_accum = imageio.imread(os.path.join(data_dir, 'flow_accum.tif'))
```

```{code-cell} ipython3
fig = plt.figure(figsize=(16, 11))

ax1 = fig.add_subplot(2, 2, 1)
ax1.set_title('Original DEM')
plt.imshow(original)

ax2 = fig.add_subplot(2, 2, 2)
ax2.set_title('Smoothed DEM')
plt.imshow(smoothed)

ax3 = fig.add_subplot(2, 2, 3)
ax3.set_title('Breached DEM')
plt.imshow(breached)

ax4 = fig.add_subplot(2, 2, 4)
ax4.set_title('Flow Accumulation')
plt.imshow(flow_accum)

plt.show()
```

## Create basemap gallery

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
for basemap in leafmap.basemaps:
    print(basemap)
```

```{code-cell} ipython3
layers = list(leafmap.basemaps.keys())[17:117]
```

```{code-cell} ipython3
leafmap.linked_maps(rows=20, cols=5, height="200px", layers=layers, labels=layers)
```

## Create linked map

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
leafmap.basemaps.keys()
```

```{code-cell} ipython3
layers = ['ROADMAP', 'HYBRID']
leafmap.linked_maps(rows=1, cols=2, height='400px', layers=layers)
```

```{code-cell} ipython3
layers = ['Stamen.Terrain', 'OpenTopoMap']
leafmap.linked_maps(rows=1, cols=2, height='400px', layers=layers)
```

Create a 2 * 2 linked map to visualize land cover change. Specify the `center` and `zoom` parameters to change the default map center and zoom level.

```{code-cell} ipython3
layers = [str(f"NLCD {year} CONUS Land Cover") for year in [2001, 2006, 2011, 2016]]
labels = [str(f"NLCD {year}") for year in [2001, 2006, 2011, 2016]]
leafmap.linked_maps(
    rows=2,
    cols=2,
    height='300px',
    layers=layers,
    labels=labels,
    center=[36.1, -115.2],
    zoom=9,
)
```

## Create split-panel map

Create a split-panel map by specifying the `left_layer` and `right_layer`, which can be chosen from the basemap names, or any custom XYZ tile layer.

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
leafmap.split_map(left_layer="ROADMAP", right_layer="HYBRID")
```

Hide the zoom control from the map.

```{code-cell} ipython3
leafmap.split_map(
    left_layer="Esri.WorldTopoMap", right_layer="OpenTopoMap", zoom_control=False
)
```

Add labels to the map and change the default map center and zoom level.

```{code-cell} ipython3
leafmap.split_map(
    left_layer="NLCD 2001 CONUS Land Cover",
    right_layer="NLCD 2019 CONUS Land Cover",
    left_label="2001",
    right_label="2019",
    label_position="bottom",
    center=[36.1, -114.9],
    zoom=10,
)
```

## Create heat map

Specify the file path to the CSV. It can either be a file locally or on the Internet.

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
m = leafmap.Map(layers_control=True)
in_csv = "https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/world_cities.csv"
m.add_heatmap(
    in_csv,
    latitude="latitude",
    longitude='longitude',
    value="pop_max",
    name="Heat map",
    radius=20,
)
m
```

Use the folium plotting backend.

```{code-cell} ipython3
from leafmap import foliumap
```

```{code-cell} ipython3
m = foliumap.Map()
in_csv = "https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/world_cities.csv"
m.add_heatmap(
    in_csv,
    latitude="latitude",
    longitude='longitude',
    value="pop_max",
    name="Heat map",
    radius=20,
)
```

```{code-cell} ipython3
colors = ['blue', 'lime', 'red']
m.add_colorbar(colors=colors, vmin=0, vmax=10000)
m.add_title("World Population Heat Map", font_size="20px", align="center")
m
```

## Save map to HTML

```{code-cell} ipython3
import leafmap
```

```{code-cell} ipython3
m = leafmap.Map()
m.add_basemap("Esri.NatGeoWorldMap")
m
```

Specify the output HTML file name to save the map as a web page.

```{code-cell} ipython3
m.to_html("mymap.html")
```

If the output HTML file name is not provided, the function will return a string containing contain the source code of the HTML file.

```{code-cell} ipython3
html = m.to_html()
```

```{code-cell} ipython3
# print(html)
```

## Use kepler plotting backend

```{code-cell} ipython3
import leafmap.kepler as leafmap
```

### Create an interactive map

Create an interactive map. You can specify various parameters to initialize the map, such as `center`, `zoom`, `height`, and `widescreen`.

```{code-cell} ipython3
m = leafmap.Map(center=[40, -100], zoom=2, height=600, widescreen=False)
m
```

If you encounter an error saying `Error displaying widget: model not found` when trying to display the map, you can use `m.static_map()` as a workaround until this [kepler.gl bug](https://github.com/keplergl/kepler.gl/issues/1165) has been resolved.  

```{code-cell} ipython3
m.static_map(width=1280, height=600)
```

### Add CSV

Add a CSV to the map. If you have a map config file, you can directly apply config to the map.

```{code-cell} ipython3
m = leafmap.Map(center=[37.7621, -122.4143], zoom=12)
in_csv = (
    'https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/hex_data.csv'
)
config = 'https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/hex_config.json'
m.add_csv(in_csv, layer_name="hex_data", config=config)
m
```

```{code-cell} ipython3
m.static_map(width=1280, height=600)
```

### Save map config

Save the map configuration as a JSON file.

```{code-cell} ipython3
m.save_config("cache/config.json")
```

### Save map as html

Save the map to an interactive html.

```{code-cell} ipython3
m.to_html(outfile="cache/kepler_hex.html")
```

### Add GeoJONS

Add a GeoJSON with US state boundaries to the map.

```{code-cell} ipython3
m = leafmap.Map(center=[50, -110], zoom=2)
polygons = 'https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/us_states.json'
m.add_geojson(polygons, layer_name="Countries")
m
```

```{code-cell} ipython3
m.static_map(width=1280, height=600)
```

### Add shapefile

Add a shapefile to the map.

```{code-cell} ipython3
m = leafmap.Map(center=[20, 0], zoom=1)
in_shp = "https://github.com/giswqs/leafmap/raw/master/examples/data/countries.zip"
m.add_shp(in_shp, "Countries")
m
```

```{code-cell} ipython3
m.static_map(width=1280, height=600)
```

### Add GeoDataFrame

Add a GeoPandas GeoDataFrame to the map.

```{code-cell} ipython3
import geopandas as gpd
```

```{code-cell} ipython3
gdf = gpd.read_file(
    "https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/world_cities.geojson"
)
gdf
```

```{code-cell} ipython3
m = leafmap.Map(center=[20, 0], zoom=1)
m.add_gdf(gdf, "World cities")
m
```

```{code-cell} ipython3
m.static_map(width=1280, height=600)
```

## Publish maps

To follow this tutorial, you will need to [sign up](https://datapane.com/accounts/signup/) for an account with <https://datapane.com>, then install and authenticate the `datapane` Python package. More information can be found [here](https://docs.datapane.com/tutorials/tut-getting-started). 

- `pip install datapane`
- `datapane login`
- `datapane ping`

![](https://i.imgur.com/oSlBHb5.png)

If you encounter folium version errors, please uncomment the following line to update folium and restart the kernel.

```{code-cell} ipython3
# !pip install -U folium
```

```{code-cell} ipython3
import os
import datapane as dp
import leafmap.foliumap as leafmap
```

```{code-cell} ipython3
if os.environ.get("DP_TOKEN") is None:
    os.environ["DP_TOKEN"] = 'your-api-key'
```

```{code-cell} ipython3
dp.login(token=os.environ['DP_TOKEN'])
```

### Elevation map

```{code-cell} ipython3
m = leafmap.Map()
m.add_basemap('USGS 3DEP Elevation')
colors = ['006633', 'E5FFCC', '662A00', 'D8D8D8', 'F5F5F5']
vmin = 0
vmax = 4000
m.add_colorbar(colors=colors, vmin=vmin, vmax=vmax)
m
```

```{code-cell} ipython3
m.publish(name="Elevation Map of North America")
```

### Land cover map

```{code-cell} ipython3
m = leafmap.Map()
m.add_basemap("NLCD 2019 CONUS Land Cover")
m.add_legend(builtin_legend='NLCD')
m
```

```{code-cell} ipython3
m.publish(name="National Land Cover Database (NLCD) 2019")
```

### Population heat map

```{code-cell} ipython3
m = leafmap.Map()
in_csv = "https://raw.githubusercontent.com/giswqs/leafmap/master/examples/data/world_cities.csv"
m.add_heatmap(
    in_csv,
    latitude="latitude",
    longitude='longitude',
    value="pop_max",
    name="Heat map",
    radius=20,
)
```

```{code-cell} ipython3
colors = ['blue', 'lime', 'red']
vmin = 0
vmax = 10000
m.add_colorbar(colors=colors, vmin=vmin, vmax=vmax)
m
```

```{code-cell} ipython3
m.publish(name="World Population Heat Map")
```

## Use planet imagery

First, you need to sign up a Planet account and get an API key. See https://www.planet.com/nicfi & https://developers.planet.com/quickstart/apis.
Uncomment the following line to pass in your API key.

```{code-cell} ipython3
import os
import leafmap
```

```{code-cell} ipython3
if os.environ.get("PLANET_API_KEY") is None:
    os.environ["PLANET_API_KEY"] = 'your-api-key'
```

```{code-cell} ipython3
biannual_tiles = leafmap.planet_biannual_tiles_tropical()
```

```{code-cell} ipython3
for tile in biannual_tiles:
    print(tile)
```

```{code-cell} ipython3
monthly_tiles = leafmap.planet_monthly_tiles_tropical()
```

```{code-cell} ipython3
for tile in monthly_tiles:
    print(tile)
```

Add a Planet monthly mosaic by specifying year and month.

```{code-cell} ipython3
m = leafmap.Map()
layer = monthly_tiles['Planet_2021-08']
m.add_layer(layer)
m
```

```{code-cell} ipython3
m = leafmap.Map()
layer = biannual_tiles['Planet_2020-06_2020-08']
m.add_layer(layer)
m
```

## Use timeseries inspector

```{code-cell} ipython3
import os
import leafmap
```

```{code-cell} ipython3
if os.environ.get("PLANET_API_KEY") is None:
    os.environ["PLANET_API_KEY"] = 'your-api-key'
```

```{code-cell} ipython3
biannual_tiles = leafmap.planet_biannual_tiles_tropical()
```

```{code-cell} ipython3
leafmap.ts_inspector(biannual_tiles, center=[8.5, -80], zoom=5)
```

```{code-cell} ipython3
monthly_tiles = leafmap.planet_monthly_tiles_tropical()
```

```{code-cell} ipython3
leafmap.ts_inspector(monthly_tiles, center=[8.5, -80], zoom=5)
```

```{code-cell} ipython3
tiles = leafmap.planet_tiles_tropical()
```

```{code-cell} ipython3
leafmap.ts_inspector(tiles, center=[8.5, -80], zoom=5)
```

## Use time slider

+++

Use the time slider to visualize Planet quarterly mosaic.

```{code-cell} ipython3
import os
import leafmap
```

```{code-cell} ipython3
if os.environ.get("PLANET_API_KEY") is None:
    os.environ["PLANET_API_KEY"] = 'your-api-key'
```

```{code-cell} ipython3
m = leafmap.Map(center=[8.5, -80], zoom=5)
layers_dict = leafmap.planet_monthly_tiles_tropical()
m.add_time_slider(layers_dict, time_interval=1)
m
```

```{code-cell} ipython3
m = leafmap.Map(center=[8.5, -80], zoom=5)
layers_dict = leafmap.planet_biannual_tiles_tropical()
m.add_time_slider(layers_dict, time_interval=1)
m
```

Use the time slider to visualize basemaps.

```{code-cell} ipython3
m = leafmap.Map()
m.clear_layers()
layers_dict = leafmap.basemap_xyz_tiles()
m.add_time_slider(layers_dict, time_interval=1)
m
```

## Use PostGIS

Setting up the conda env:

```
conda create -n geo python=3.8
conda activate geo
conda install geopandas
conda install mamba -c conda-forge
mamba install leafmap sqlalchemy psycopg2 -c conda-forge
```

Sample dataset:
- [nyc_data.zip](https://github.com/giswqs/postgis/raw/master/data/nyc_data.zip) (Watch this [video](https://youtu.be/fROzLrjNDrs) to load data into PostGIS)

### Connect to the database

You can directly pass in the user name and password to access the database. Alternative, you can define environment variables. The default environment variables for user and password are `SQL_USER` and `SQL_PASSWORD`, respectively.

The `try...except...` statements are only used for building the documentation website (https://leafmap.org) because the PostGIS database is not available on GitHub. If you are running the notebook with Jupyter installed locally and PostGIS set up properly, you don't need these `try...except...` statements.

```{code-cell} ipython3
try:
    con = leafmap.connect_postgis(
        database="nyc", host="localhost", user=None, password=None, use_env_var=True
    )
except:
    pass
```

### Perform SQL queries

Create a GeoDataFrame from a sql query.

```{code-cell} ipython3
sql = 'SELECT * FROM nyc_neighborhoods'
```

```{code-cell} ipython3
try:
    gdf = leafmap.read_postgis(sql, con)
    display(gdf)
except:
    pass
```

### Display data on the map

```{code-cell} ipython3
try:
    m = leafmap.Map()
    m.add_gdf_from_postgis(
        sql, con, layer_name="NYC Neighborhoods", fill_colors=["red", "green", "blue"]
    )
    display(m)
except:
    pass
```

![](https://i.imgur.com/mAXaBCv.gif)

+++

## Add widget to the map

```{code-cell} ipython3
import leafmap
import numpy as np
import matplotlib.pyplot as plt
from ipywidgets import Output
from ipyleaflet import WidgetControl
```

```{code-cell} ipython3
m = leafmap.Map()

# Data for plotting
t = np.arange(0.0, 2.0, 0.01)
s = 1 + np.sin(2 * np.pi * t)

fig, ax = plt.subplots()
ax.plot(t, s)

ax.set(
    xlabel='time (s)', ylabel='voltage (mV)', title='About as simple as it gets, folks'
)
ax.grid()

# Create an output widget to host the plot
output_widget = Output()

# Show the plot on the widget
with output_widget:
    output_widget.clear_output()
    plt.show()

# Add the widget as a control to the map
output_control = WidgetControl(widget=output_widget, position="bottomright")
m.add_control(output_control)
```

```{code-cell} ipython3
m
```

## Develop custom widgets

```{code-cell} ipython3
import leafmap
import ipywidgets as widgets
from ipyleaflet import WidgetControl
```

### Create a toolbar button

```{code-cell} ipython3
widget_width = "250px"
padding = "0px 0px 0px 5px"  # upper, right, bottom, left

toolbar_button = widgets.ToggleButton(
    value=False,
    tooltip="Toolbar",
    icon="gears",
    layout=widgets.Layout(width="28px", height="28px", padding=padding),
)

close_button = widgets.ToggleButton(
    value=False,
    tooltip="Close the tool",
    icon="times",
    button_style="primary",
    layout=widgets.Layout(height="28px", width="28px", padding=padding),
)
```

```{code-cell} ipython3
toolbar = widgets.HBox([toolbar_button])
toolbar
```

### Add toolbar event

```{code-cell} ipython3
def toolbar_click(change):
    if change["new"]:
        toolbar.children = [toolbar_button, close_button]
    else:
        toolbar.children = [toolbar_button]


toolbar_button.observe(toolbar_click, "value")
```

```{code-cell} ipython3
def close_click(change):
    if change["new"]:
        toolbar_button.close()
        close_button.close()
        toolbar.close()


close_button.observe(close_click, "value")
toolbar
```

### Add a toolbar grid

```{code-cell} ipython3
rows = 2
cols = 2
grid = widgets.GridspecLayout(
    rows, cols, grid_gap="0px", layout=widgets.Layout(width="65px")
)
```

icons: https://fontawesome.com/v4.7.0/icons/

```{code-cell} ipython3
icons = ["folder-open", "map", "info", "question"]

for i in range(rows):
    for j in range(cols):
        grid[i, j] = widgets.Button(
            description="",
            button_style="primary",
            icon=icons[i * rows + j],
            layout=widgets.Layout(width="28px", padding="0px"),
        )
grid
```

```{code-cell} ipython3
toolbar = widgets.VBox([toolbar_button])
```

```{code-cell} ipython3
def toolbar_click(change):
    if change["new"]:
        toolbar.children = [widgets.HBox([close_button, toolbar_button]), grid]
    else:
        toolbar.children = [toolbar_button]


toolbar_button.observe(toolbar_click, "value")
toolbar
```

### Add toolbar to leafmap

```{code-cell} ipython3
toolbar_ctrl = WidgetControl(widget=toolbar, position="topright")
```

```{code-cell} ipython3
m = leafmap.Map()
m.add_control(toolbar_ctrl)
m
```

```{code-cell} ipython3
output = widgets.Output()
output_ctrl = WidgetControl(widget=output, position="bottomright")
m.add_control(output_ctrl)
```

```{code-cell} ipython3
def tool_click(b):
    with output:
        output.clear_output()
        print(f"You clicked the {b.icon} button")
```

```{code-cell} ipython3
for i in range(rows):
    for j in range(cols):
        tool = grid[i, j]
        tool.on_click(tool_click)
```

![](https://i.imgur.com/3LbyC1Y.gif)
